package main;

import dao.AppointmentDAO;
import dao.EventDAO;
import dao.PetDAO;
import dao.UserDAO;
import dao.VaccinationDAO;
import model.Event;
import model.Pet;
import model.User;
import model.Appointment;
import model.Vaccination;

import javax.swing.*;
import javax.swing.table.DefaultTableModel;
import java.awt.*;
import java.sql.Date;
import java.util.ArrayList;

public class LoginScreen {
    private static JFrame frame;
    private static JPanel panelLogin = new JPanel(new GridBagLayout());
    private static JPanel panelEvent = new JPanel(new BorderLayout());
    private static JPanel panelPet = new JPanel(new BorderLayout());
    private static JPanel panelAppointment = new JPanel(new BorderLayout());
    private static JPanel panelVaccination = new JPanel(new BorderLayout());
    private static JPanel panelMain = new JPanel(new BorderLayout());

    public static void main(String[] args) {
        frame = new JFrame("\uD83D\uDD10 ƒêƒÉng nh·∫≠p h·ªá th·ªëng");
        frame.setSize(400, 300);
        frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        frame.setLocationRelativeTo(null);
        setupLoginPanel();
        frame.setVisible(true);
    }

    private static void setupLoginPanel() {
        panelLogin.removeAll();
        panelLogin.setBorder(BorderFactory.createEmptyBorder(20, 20, 20, 20));
        panelLogin.setBackground(new Color(173, 216, 230));

        GridBagConstraints gbc = new GridBagConstraints();
        gbc.fill = GridBagConstraints.HORIZONTAL;
        gbc.insets = new Insets(10, 10, 10, 10);
        gbc.gridx = 0;
        panelLogin.setLayout(new GridBagLayout());

        JLabel lblTitle = new JLabel("MENAGERIE", SwingConstants.CENTER);
        lblTitle.setFont(new Font("Arial", Font.BOLD, 18));
        gbc.gridy = 0;
        panelLogin.add(lblTitle, gbc);

        JLabel lblUser = new JLabel("\uD83D\uDC64 T√™n ƒëƒÉng nh·∫≠p:");
        gbc.gridy++;
        panelLogin.add(lblUser, gbc);

        JTextField txtUsername = new JTextField(15);
        gbc.gridy++;
        panelLogin.add(txtUsername, gbc);

        JLabel lblPass = new JLabel("\uD83D\uDD11 M·∫≠t kh·∫©u:");
        gbc.gridy++;
        panelLogin.add(lblPass, gbc);

        JPasswordField txtPassword = new JPasswordField(15);
        gbc.gridy++;
        panelLogin.add(txtPassword, gbc);

        JButton btnLogin = new JButton("\uD83D\uDD10 ƒêƒÉng nh·∫≠p");
        JButton btnRegister = new JButton("\uD83D\uDCDD ƒêƒÉng k√Ω");
        gbc.gridy++;
        panelLogin.add(btnLogin, gbc);
        gbc.gridy++;
        panelLogin.add(btnRegister, gbc);

        frame.setContentPane(panelLogin);
        frame.revalidate();

        btnLogin.addActionListener(e -> {
            String username = txtUsername.getText().trim();
            String password = new String(txtPassword.getPassword()).trim();
            UserDAO userDAO = new UserDAO();

            if (username.isEmpty() || password.isEmpty()) {
                JOptionPane.showMessageDialog(frame, "‚ùó Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t√†i kho·∫£n v√† m·∫≠t kh·∫©u!", "Thi·∫øu th√¥ng tin", JOptionPane.WARNING_MESSAGE);
            } else if (userDAO.login(username, password)) {
                showMenu();
            } else {
                JOptionPane.showMessageDialog(frame, "‚ùå Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!", "L·ªói ƒëƒÉng nh·∫≠p", JOptionPane.ERROR_MESSAGE);
            }
        });

        btnRegister.addActionListener(e -> {
            String username = txtUsername.getText().trim();
            String password = new String(txtPassword.getPassword()).trim();
            UserDAO userDAO = new UserDAO();

            if (username.isEmpty() || password.isEmpty()) {
                JOptionPane.showMessageDialog(frame, "‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªÉ ƒëƒÉng k√Ω!");
            } else if (userDAO.register(new User(username, password))) {
                JOptionPane.showMessageDialog(frame, "üü¢ ƒêƒÉng k√Ω th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ ƒëƒÉng nh·∫≠p.");
            } else {
                JOptionPane.showMessageDialog(frame, "‚ö†Ô∏è T√™n ng∆∞·ªùi d√πng ƒë√£ t·ªìn t·∫°i!");
            }
        });
    }

    private static void showMenu() {
        frame.getContentPane().removeAll();
        frame.repaint();
        frame.revalidate();
        frame.setTitle("\uD83C\uDFAF Qu·∫£n l√Ω h·ªá th·ªëng");
        frame.setSize(700, 500);
        frame.setLayout(new BorderLayout());

        JMenuBar menuBar = new JMenuBar();
        JMenu menuFile = new JMenu("\uD83D\uDD0D Qu·∫£n l√Ω ch√≠nh");

        JMenuItem manageEvents = new JMenuItem("\uD83D\uDEA0 Qu·∫£n l√Ω s·ª± ki·ªán");
        JMenuItem managePets = new JMenuItem("\uD83D\uDC36 Qu·∫£n l√Ω th√∫ c∆∞ng");
        JMenuItem manageAppointments = new JMenuItem("\uD83D\uDCC5 Qu·∫£n l√Ω l·ªãch h·∫πn");
        JMenuItem manageVaccinations = new JMenuItem("\uD83D\uDC89 Qu·∫£n l√Ω ti√™m ch·ªßng");
        JMenuItem visualizePets = new JMenuItem("\uD83D\uDCC8 Tr·ª±c quan th√∫ c∆∞ng");
        JMenuItem exit = new JMenuItem("\uD83D\uDEAA ƒêƒÉng xu·∫•t");

        menuFile.add(manageEvents);
        menuFile.add(managePets);
        menuFile.add(manageAppointments);
        menuFile.add(manageVaccinations);
        menuFile.add(visualizePets);
        menuFile.add(exit);

        menuBar.add(menuFile);
        frame.setJMenuBar(menuBar);

        panelMain.removeAll();
        panelMain.setBackground(new Color(230, 245, 255));
        panelMain.add(new JLabel("\uD83C\uDFAF Ch√†o m·ª´ng ƒë·∫øn h·ªá th·ªëng qu·∫£n l√Ω!", SwingConstants.CENTER), BorderLayout.CENTER);
        frame.add(panelMain, BorderLayout.CENTER);
        frame.repaint();
        frame.revalidate();

        manageEvents.addActionListener(e -> {
            setupEventPanel();
            frame.setContentPane(panelEvent);
            frame.revalidate();
        });

        managePets.addActionListener(e -> {
            setupPetPanel();
            frame.setContentPane(panelPet);
            frame.revalidate();
        });

        manageAppointments.addActionListener(e -> {
            setupAppointmentPanel();
            frame.setContentPane(panelAppointment);
            frame.revalidate();
        });

        manageVaccinations.addActionListener(e -> {
            setupVaccinationPanel();
            frame.setContentPane(panelVaccination);
            frame.revalidate();
        });

        visualizePets.addActionListener(e -> {
            panelMain.removeAll();
            panelMain.setLayout(new BorderLayout());
            panelMain.setBackground(new Color(230, 245, 255));
            panelMain.add(ChartViewer.getPetSpeciesChartPanel(), BorderLayout.CENTER);
            frame.setContentPane(panelMain);
            frame.revalidate();
        });

        exit.addActionListener(e -> {
            int confirm = JOptionPane.showConfirmDialog(frame, "B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?", "X√°c nh·∫≠n", JOptionPane.YES_NO_OPTION);
            if (confirm == JOptionPane.YES_OPTION) {
                setupLoginPanel();
            }
        });
    }

    private static void setupEventPanel() {
        panelEvent.removeAll();
        panelEvent.setBackground(new Color(230, 245, 255));

        String[] columns = {"T√™n", "Ng√†y", "Lo·∫°i", "Ghi ch√∫"};
        DefaultTableModel model = new DefaultTableModel(new Object[0][0], columns);
        JTable table = new JTable(model);
        JScrollPane scrollPane = new JScrollPane(table);
        panelEvent.add(scrollPane, BorderLayout.CENTER);

        JPanel panelButtons = new JPanel();
        JButton btnAdd = new JButton("‚ûï Th√™m");
        JButton btnDelete = new JButton("‚ùå X√≥a");
        JButton btnRefresh = new JButton("üîÑ L√†m m·ªõi");
        JButton btnBack = new JButton("üîô Tr·ªü v·ªÅ");
        JButton btnSortAsc = new JButton("üîº S·∫Øp x·∫øp tƒÉng d·∫ßn");

        panelButtons.add(btnAdd);
        panelButtons.add(btnDelete);
        panelButtons.add(btnRefresh);
        panelButtons.add(btnBack);
        panelButtons.add(btnSortAsc);
        panelEvent.add(panelButtons, BorderLayout.SOUTH);

        btnRefresh.addActionListener(e -> loadEventData(model));
        btnRefresh.doClick();

        btnBack.addActionListener(e -> showMenu());

        btnAdd.addActionListener(e -> {
            model.addRow(new Object[]{"S·ª± ki·ªán m·ªõi", new Date(System.currentTimeMillis()), "", ""});
        });

        btnDelete.addActionListener(e -> {
            int row = table.getSelectedRow();
            if (row != -1) {
                int confirm = JOptionPane.showConfirmDialog(frame, "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·ª± ki·ªán n√†y?", "X√°c nh·∫≠n", JOptionPane.YES_NO_OPTION);
                if (confirm == JOptionPane.YES_OPTION) {
                    model.removeRow(row);
                }
            } else {
                JOptionPane.showMessageDialog(frame, "Vui l√≤ng ch·ªçn m·ªôt s·ª± ki·ªán ƒë·ªÉ x√≥a!");
            }
        });

        btnSortAsc.addActionListener(e -> {
            EventDAO dao = new EventDAO();
            ArrayList<Event> events = new ArrayList<>(dao.getAllEvents());

            // Bubble Sort theo ng√†y
            for (int i = 0; i < events.size() - 1; i++) {
                for (int j = 0; j < events.size() - i - 1; j++) {
                    if (events.get(j).getDate().compareTo(events.get(j + 1).getDate()) > 0) {
                        Event temp = events.get(j);
                        events.set(j, events.get(j + 1));
                        events.set(j + 1, temp);
                    }
                }
            }

            
            model.setRowCount(0);
            for (Event ev : events) {
                model.addRow(new Object[]{ev.getName(), ev.getDate(), ev.getType(), ev.getRemark()});
            }
        });

    }

    private static void loadEventData(DefaultTableModel model) {
        EventDAO dao = new EventDAO();
        ArrayList<Event> events = new ArrayList<>(dao.getAllEvents());

        events.sort((e1, e2) -> e2.getDate().compareTo(e1.getDate()));
        model.setRowCount(0);
        for (Event ev : events) {
            model.addRow(new Object[]{ev.getName(), ev.getDate(), ev.getType(), ev.getRemark()});
        }
    }

    private static void setupPetPanel() {
        panelPet.removeAll();
        panelPet.setBackground(new Color(230, 245, 255));

        String[] columns = {"T√™n th√∫ c∆∞ng", "Ch·ªß", "Lo√†i", "Gi·ªõi t√≠nh", "Ng√†y sinh", "Ng√†y m·∫•t"};

        DefaultTableModel model = new DefaultTableModel(new Object[0][0], columns);
        JTable table = new JTable(model);
        JScrollPane scrollPane = new JScrollPane(table);
        panelPet.add(scrollPane, BorderLayout.CENTER);

        JPanel panelButtons = new JPanel();
        JButton btnAdd = new JButton("‚ûï Th√™m");
        JButton btnDelete = new JButton("‚ùå X√≥a");
        JButton btnRefresh = new JButton("üîÑ L√†m m·ªõi");
        JButton btnBack = new JButton("üîô Tr·ªü v·ªÅ");
        JButton btnSortAsc = new JButton("üîº S·∫Øp x·∫øp tƒÉng d·∫ßn");
        JButton btnUndoSort = new JButton("‚Ü©Ô∏è Ho√†n t√°c s·∫Øp x·∫øp");
        panelButtons.add(btnAdd);
        panelButtons.add(btnDelete);
        panelButtons.add(btnRefresh);
        panelButtons.add(btnBack);
        panelButtons.add(btnSortAsc);
        panelButtons.add(btnUndoSort);
        panelPet.add(panelButtons, BorderLayout.SOUTH);

        btnRefresh.addActionListener(e -> loadPetData(model));
        btnRefresh.doClick();

        btnBack.addActionListener(e -> showMenu());

        btnDelete.addActionListener(e -> {
            int row = table.getSelectedRow();
            if (row != -1) {
                int confirm = JOptionPane.showConfirmDialog(frame, "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th√∫ c∆∞ng n√†y?", "X√°c nh·∫≠n", JOptionPane.YES_NO_OPTION);
                if (confirm == JOptionPane.YES_OPTION) {
                    model.removeRow(row);
                }
            } else {
                JOptionPane.showMessageDialog(frame, "Vui l√≤ng ch·ªçn th√∫ c∆∞ng ƒë·ªÉ x√≥a!");
            }
        });

        btnAdd.addActionListener(e -> {
            model.addRow(new Object[]{"T√™n m·ªõi", "Lo√†i", new Date(System.currentTimeMillis()), "Ch·ªß"});
        });
    }

    private static void loadPetData(DefaultTableModel model) {
        PetDAO dao = new PetDAO();
        ArrayList<Pet> pets = new ArrayList<>(dao.getAllPets());
        model.setRowCount(0);
        for (Pet pet : pets) {
        	model.addRow(new Object[]{pet.getName(), pet.getOwner(), pet.getSpecies(), pet.getSex(), pet.getBirth(), pet.getDeath()});

        }
    }

    //
    private static void setupAppointmentPanel() {
        panelAppointment.removeAll();
        panelAppointment.setBackground(new Color(230, 245, 255));

        String[] columns = {"ID", "T√™n th√∫ c∆∞ng", "Ng√†y h·∫πn", "Ghi ch√∫"};
        DefaultTableModel model = new DefaultTableModel(new Object[0][0], columns);
        JTable table = new JTable(model);
        JScrollPane scrollPane = new JScrollPane(table);
        panelAppointment.add(scrollPane, BorderLayout.CENTER);

        JPanel panelButtons = new JPanel();
        JButton btnAdd = new JButton("‚ûï Th√™m");
        JButton btnDelete = new JButton("‚ùå X√≥a");
        JButton btnRefresh = new JButton("üîÑ L√†m m·ªõi");
        JButton btnBack = new JButton("üîô Tr·ªü v·ªÅ");
        JButton btnSortAsc = new JButton("üîº S·∫Øp x·∫øp tƒÉng d·∫ßn");
        JButton btnUndoSort = new JButton("‚Ü©Ô∏è Ho√†n t√°c s·∫Øp x·∫øp");
       
        panelButtons.add(btnSortAsc);
        panelButtons.add(btnUndoSort);
        panelButtons.add(btnAdd);
        panelButtons.add(btnDelete);
        panelButtons.add(btnRefresh);
        panelButtons.add(btnBack);
        panelAppointment.add(panelButtons, BorderLayout.SOUTH);

        btnRefresh.addActionListener(e -> loadAppointmentData(model));
        btnRefresh.doClick();

        btnBack.addActionListener(e -> showMenu());

        btnDelete.addActionListener(e -> {
            int row = table.getSelectedRow();
            if (row != -1) {
                int confirm = JOptionPane.showConfirmDialog(frame, "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a l·ªãch h·∫πn n√†y?", "X√°c nh·∫≠n", JOptionPane.YES_NO_OPTION);
                if (confirm == JOptionPane.YES_OPTION) {
                    model.removeRow(row);
                }
            } else {
                JOptionPane.showMessageDialog(frame, "Vui l√≤ng ch·ªçn l·ªãch h·∫πn ƒë·ªÉ x√≥a!");
            }
        });

        btnAdd.addActionListener(e -> {
            model.addRow(new Object[]{null, "T√™n th√∫ c∆∞ng", new Date(System.currentTimeMillis()), "Ghi ch√∫"});
        });
    }

    private static void loadAppointmentData(DefaultTableModel model) {
        AppointmentDAO dao = new AppointmentDAO();
        ArrayList<Appointment> list = new ArrayList<>(dao.getAllAppointments());
        model.setRowCount(0);
        for (Appointment ap : list) {
            model.addRow(new Object[]{ap.getId(), ap.getPetName(), ap.getDate(), ap.getReason()});
        }
    }

    
    private static void setupVaccinationPanel() {
        panelVaccination.removeAll();
        panelVaccination.setBackground(new Color(230, 245, 255));

        String[] columns = {"ID", "T√™n th√∫ c∆∞ng", "T√™n vacxin", "Ng√†y ti√™m", "Ghi ch√∫"};
        DefaultTableModel model = new DefaultTableModel(new Object[0][0], columns);
        JTable table = new JTable(model);
        JScrollPane scrollPane = new JScrollPane(table);
        panelVaccination.add(scrollPane, BorderLayout.CENTER);

        JPanel panelButtons = new JPanel();
        JButton btnAdd = new JButton("‚ûï Th√™m");
        JButton btnDelete = new JButton("‚ùå X√≥a");
        JButton btnRefresh = new JButton("üîÑ L√†m m·ªõi");
        JButton btnBack = new JButton("üîô Tr·ªü v·ªÅ");
        JButton btnSortAsc = new JButton("üîº S·∫Øp x·∫øp tƒÉng d·∫ßn");
        JButton btnUndoSort = new JButton("‚Ü©Ô∏è Ho√†n t√°c s·∫Øp x·∫øp");
       
        panelButtons.add(btnSortAsc);
        panelButtons.add(btnUndoSort);
        panelButtons.add(btnAdd);
        panelButtons.add(btnDelete);
        panelButtons.add(btnRefresh);
        panelButtons.add(btnBack);
        panelVaccination.add(panelButtons, BorderLayout.SOUTH);

        btnRefresh.addActionListener(e -> loadVaccinationData(model));
        btnRefresh.doClick();

        btnBack.addActionListener(e -> showMenu());

        btnDelete.addActionListener(e -> {
            int row = table.getSelectedRow();
            if (row != -1) {
                int confirm = JOptionPane.showConfirmDialog(frame, "B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫£n ghi ti√™m ch·ªßng n√†y?", "X√°c nh·∫≠n", JOptionPane.YES_NO_OPTION);
                if (confirm == JOptionPane.YES_OPTION) {
                    model.removeRow(row);
                }
            } else {
                JOptionPane.showMessageDialog(frame, "Vui l√≤ng ch·ªçn b·∫£n ghi ti√™m ch·ªßng ƒë·ªÉ x√≥a!");
            }
        });

        btnAdd.addActionListener(e -> {
            model.addRow(new Object[]{null, "T√™n th√∫ c∆∞ng", "T√™n vacxin", new Date(System.currentTimeMillis()), "Ghi ch√∫"});
        });
    }

    private static void loadVaccinationData(DefaultTableModel model) {
        VaccinationDAO dao = new VaccinationDAO();
        ArrayList<Vaccination> list = new ArrayList<>(dao.getAllVaccinations());
        model.setRowCount(0);
        for (Vaccination v : list) {
            model.addRow(new Object[]{v.getId(), v.getPetName(), v.getVaccineName(), v.getDate(), v.getNotes()});
        }
    }
}
